#!/usr/bin/env python
import argparse
import os
import sys

import beastling.configuration
import beastling.beastxml

def main():

    # Parse command line arguments
    parser = argparse.ArgumentParser()
    parser.add_argument("config", help="Beastling configuration file", default=None)
    parser.add_argument("output", nargs="?", help="Output filename, no extension (default beastling)", default=None)
    parser.add_argument("--overwrite", default=False, action="store_true")
    parser.add_argument("--stdin", default=False, action="store_true")
    args = parser.parse_args()

    # Build config object
    try:
        config = beastling.configuration.Configuration(basename=args.output, configfile=args.config, stdin_data=args.stdin)
        config.process()
    except Exception as e:
        sys.stderr.write("Error encountered while parsing configuration file:\n")
        sys.stderr.write(str(e))
        sys.exit(1)

    # Build XML file
    xml = beastling.beastxml.BeastXml(config)

    # Write XML file
    filename = args.output if args.output else config.basename+".xml"
    if os.path.exists(filename) and not args.overwrite:
        sys.stderr.write("File %s already exists!  Run beastling with the --overwrite option if you wish to overwrite it.\n" % filename)
        sys.exit(1)
    xml.write_file(filename)

if __name__ == "__main__":
    main()
